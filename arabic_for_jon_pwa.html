<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arabic for Jon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script>
    // --- PWA manifest with embedded icon (Wael art) ---
    const manifest = {
      name: "Arabic for Jon",
      short_name: "Arabic",
      start_url: ".",
      display: "standalone",
      background_color: "#000000",
      theme_color: "#000000",
      icons: [
        {
          src: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QCMRXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAKgAgAEAAAAAQAAAFigAwAEAAAAAQAAAGoAAAAA/+EDQ2FsaWJyYXRlZCB3aXRoIEdJTVD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAA2AO4DASIAAhEBAxEB/8QAHQAAAgIDAQEBAQAAAAAAAAAABQYEBwEDCAIBCf/EAEgQAAECBAQDBQcECAQDCQEAAAECEQADBCEFEjEGQVFhEyKxgRQykbHB0eHwFCNSYuEzgpLh8XKyJEOTFjNUk6L/xAAZAQADAQEBAAAAAAAAAAAAAAABAgMABAX/xAAsEQACAgICAgEDBAICAwAAAAAAAAECESExAxJBUXETImFxgZGhsf/aAAwDAQACEQMRAD8A+4iiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgk3IuwnGckL9iDTjFcF3p33c0f51QDx1HwhL7z63H9lWvIYa4txOF4puJ5uF7tDX5g8+prPqjHNaSXFrHYnLsL3rsOXZ51Kp2W1ss6uF95zNvXXrPpcvKtnG3qVxvdvR4bP7nyS5+ZV2xuuSPf5PH0p7y5KcVtbZW9w5i9eV1fY8Os9QXOtq9tbfJvNbe08P0I5+0fH0qvMG6GsrK21pBaW3A7d6+5VfZcTX6ozx9Y7h+0+X7L7n6Co7bW2u7t5bu8vjqKp+UxH0Iu8pC6r6bXV9q2vt5rdP82uXLX0n7TR2l9S0HTLd1/3L4N5PO3+VVJ7m0djc7rW9mm2u3r5445b4P0pWksfYw2y2t413JXnF2PX3+le0e1m8lWl1G8mls7vLq45jKx7nj+VeC8Vb1Gaqrm8s7rueznedff5Vbbi21bafW+JsPdd+l7bT6C5Z7Odfp8Pqa73tGvL2q3K7dS7ay7x3f5k+dMXmrdSy8HsF0pLsbq9+W5f+TOt5q6JktzSjcN2u8ea8t8KmlvDe2XcO7fP0P8Afa7qVj3qN9V60bVdY8pOa7L6Nw+yp87Hy9v3U3Z2k3urxt7kvOfobj9J8tKqpCiiiqICoqKqCq9sabfX7Xz2fa4e3VC6klq1nbbX8mtaW1w4fN2+Tg/Td57bT2OtW1f3ek31+Rd7cXvP0+J+tZw+wtb7GztdFxu3s+Xj/AOHT9K8E3qLqRrq2ldbrfWfN+r3X9vlOPqaFtc13bi9j3br6r7nHFRTUdFURQEUBFARQEVBRUCuW2M7Vdr3bW7T39v3SNKez8Hapdtz81vqv3ntvyuObk9d9NRZp7W7Ky1pZbq63t3d9P4uPH87fpWte+jq2rXunS7mb5WfF3TzZ3ej+9fK8h+1zU3s9vdrt0u3t43knlPqaW/8AZnj5m+z+FH9spPCtG5Jbq3ttt7c3Pp5Zz9PSsL2c3b3vLw2+V5tX3yk1JXaoxy61dml7Z9yt5P5s6p7u1G6pq3d1d04t/eX8DKzzq6Nt7V7J/AGt4rx3sy9W/ZXGeoeqY/JW1/Av5W9Y3JpLbTy5b7t3d7cv89/TvFXdV9zX0p0PqfBvpGqqgqqKCqCoiqAioCKAioCKAioCKAioCKAioCKAioCKAioCKAioCKAioCKAioCKAioCKA//2Q==",
          sizes: "512x512",
          type: "image/jpeg"
        }
      ]
    };

    (function attachManifest() {
      const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link");
      link.rel = "manifest";
      link.href = url;
      document.head.appendChild(link);
    })();

    // --- Service worker for offline support ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        const swCode = `
          const CACHE = 'arabic-for-jon-v2';
          self.addEventListener('install', e => {
            e.waitUntil(
              caches.open(CACHE).then(c => c.addAll(['./', './arabic_for_jon_pwa.html']))
            );
          });
          self.addEventListener('fetch', e => {
            e.respondWith(
              caches.match(e.request).then(r => r || fetch(e.request))
            );
          });
        `;
        const blob = new Blob([swCode], { type: "application/javascript" });
        const swURL = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swURL);
      });
    }
  </script>

  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.2);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --known: #22c55e;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1.15rem;
      margin: 0;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .counter {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .streak {
      font-size: 0.8rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
      align-items: center;
    }

    .filters-row label {
      color: var(--text-muted);
      margin-right: 2px;
    }

    .filters-row select {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .mode-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 3px 9px;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .mode-chip.active {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f97316, #f59e0b);
      color: #0b1120;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .tab {
      flex: 1;
      padding: 6px 0;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.8rem;
      text-align: center;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    .tab.active {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f97316, #f59e0b);
      color: #0b1120;
      font-weight: 600;
    }

    .card {
      position: relative;
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 24px;
      padding: 30px 24px 20px;
      min-height: 290px;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, var(--accent-soft), transparent 60%);
      pointer-events: none;
    }

    .pill {
      position: absolute;
      top: 14px;
      left: 16px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .side-label {
      position: absolute;
      top: 14px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(249, 115, 22, 0.4);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    .known-pill {
      position: absolute;
      bottom: 14px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid var(--known);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--known);
    }

    .english {
      font-size: 2.3rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      padding: 0 8px;
    }

    .arabic {
      font-size: 2.4rem;
      line-height: 1.5;
      direction: rtl;
      font-family: -apple-system, system-ui, "SF Arabic", "Geeza Pro",
        "Arial", "Segoe UI", sans-serif;
    }

    .translit {
      margin-top: 8px;
      font-size: 1.05rem;
      color: var(--text-muted);
    }

    .hint {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 10px 12px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    button.primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f97316, #f59e0b);
      color: #0b1120;
      box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
    }

    button.ghost {
      background: rgba(15,23,42,0.9);
    }

    button.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    footer {
      margin-top: 8px;
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .typing-area {
      margin-top: 10px;
      width: 100%;
    }

    .typing-area input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 0.9rem;
    }

    .typing-feedback {
      margin-top: 5px;
      font-size: 0.8rem;
    }

    .typing-feedback.ok {
      color: var(--known);
    }

    .typing-feedback.bad {
      color: var(--danger);
    }

    .audio-btn {
      position: absolute;
      bottom: 14px;
      left: 16px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .canvas-wrap {
      margin-top: 8px;
      width: 100%;
      display: none;
      flex-direction: column;
      gap: 4px;
    }

    .canvas-wrap canvas {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.6);
      touch-action: none;
    }

    .quiz-panel {
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 14px 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .quiz-question {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quiz-option {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.85rem;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
    }

    .quiz-option.correct {
      border-color: var(--known);
      background: rgba(34, 197, 94, 0.12);
    }

    .quiz-option.wrong {
      border-color: var(--danger);
      background: rgba(248, 113, 113, 0.12);
    }

    .quiz-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>Levantine Arabic</h1>
        <span id="counter" class="counter"></span>
      </div>
      <div class="streak" id="streak-label">üî• 0-day streak</div>
    </header>

    <div class="filters-row">
      <div>
        <label for="category-filter">Category</label>
        <select id="category-filter"></select>
      </div>
      <div>
        <label for="status-filter">Show</label>
        <select id="status-filter">
          <option value="all">All</option>
          <option value="unknown">Unknown</option>
          <option value="known">Known</option>
        </select>
      </div>
      <div class="mode-chip" id="smart-mode-chip">Smart mode: off</div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab-cards">Cards</div>
      <div class="tab" id="tab-quiz">Quiz</div>
    </div>

    <div id="cards-view">
      <div id="card" class="card">
        <div class="pill" id="category-pill"></div>
        <div class="side-label" id="side-label">Front ¬∑ EN</div>
        <div id="known-pill" class="known-pill" style="display:none;">Known</div>
        <div class="audio-btn" id="audio-btn">üîä Audio</div>
        <div id="card-content"></div>
        <div class="hint" id="hint-text">
          Tap card / ‚ÄúFlip‚Äù to see Arabic ¬∑ ÿßÿ∂ÿ∫ÿ∑ / ÿ•ÿ∂ÿ∫ÿ∑Ÿä ŸÑÿ™ŸÇŸÑŸäÿ® ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©
        </div>
      </div>

      <div class="typing-area" id="typing-area" style="display:none;">
        <input id="typing-input" placeholder="Type the transliteration (e.g. keef)" />
        <div id="typing-feedback" class="typing-feedback"></div>
      </div>

      <div class="canvas-wrap" id="canvas-wrap">
        <canvas id="write-canvas"></canvas>
        <div class="controls">
          <button class="small ghost" id="clear-canvas-btn">Clear drawing</button>
        </div>
      </div>

      <div class="controls">
        <button id="prev-btn">‚üµ Previous</button>
        <button id="flip-btn" class="primary">Flip</button>
        <button id="next-btn">Next ‚ü∂</button>
      </div>

      <div class="controls">
        <button id="toggle-known-btn" class="ghost small">Mark as Known ‚úÖ</button>
        <button id="shuffle-btn" class="small">Shuffle deck üîÄ</button>
      </div>

      <div class="controls">
        <button id="typing-toggle-btn" class="small ghost">Typing practice ‚å®Ô∏è</button>
        <button id="canvas-toggle-btn" class="small ghost">Handwriting ‚úèÔ∏è</button>
      </div>

      <div class="controls">
        <button id="got-it-btn" class="small">I got it üëç</button>
        <button id="oops-btn" class="small ghost">I was wrong üòÖ</button>
      </div>
    </div>

    <div id="quiz-view" style="display:none;">
      <div class="quiz-panel" id="quiz-panel">
        <div class="quiz-question" id="quiz-question"></div>
        <div class="quiz-options" id="quiz-options"></div>
        <div class="quiz-meta">
          <span id="quiz-progress"></span>
          <span id="quiz-result"></span>
        </div>
      </div>
      <div class="controls">
        <button id="start-quiz-btn" class="primary small">Start quiz üéØ</button>
        <button id="reset-quiz-btn" class="ghost small">Reset quiz</button>
      </div>
    </div>

    <footer>
      Progress, streaks & known words are saved on this device only.
    </footer>
  </div>

  <script>
    // ---- DATA ----
    const cards = [
      // 1. Days of the Week / Time Words
      { category: "Days", front: "Sunday", arabic: "ÿßŸÑÿ£ÿ≠ÿØ", translit: "el-ahad" },
      { category: "Days", front: "Monday", arabic: "ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ", translit: "et-tnein" },
      { category: "Days", front: "Tuesday", arabic: "ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°", translit: "et-talata" },
      { category: "Days", front: "Wednesday", arabic: "ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°", translit: "el-arbaa" },
      { category: "Days", front: "Thursday", arabic: "ÿßŸÑÿÆŸÖŸäÿ≥", translit: "el-khamees" },
      { category: "Days", front: "Friday", arabic: "ÿßŸÑÿ¨ŸÖÿπÿ©", translit: "el-jomaa" },
      { category: "Days", front: "Saturday", arabic: "ÿßŸÑÿ≥ÿ®ÿ™", translit: "es-sabt" },

      { category: "Time Words", front: "today", arabic: "ÿßŸÑŸäŸàŸÖ", translit: "elyom" },
      { category: "Time Words", front: "tomorrow", arabic: "ÿ®ŸÉÿ±ÿß", translit: "bukra" },
      { category: "Time Words", front: "day after tomorrow", arabic: "ÿ®ÿπÿØ ÿ®ŸÉÿ±ÿß", translit: "baad bukra" },
      { category: "Time Words", front: "yesterday", arabic: "ŸÖÿ®ÿßÿ±ÿ≠", translit: "mbarah" },
      { category: "Time Words", front: "day before yesterday", arabic: "ŸÇÿ®ŸÑ ŸÖÿ®ÿßÿ±ÿ≠", translit: "abl mbarah" },
      { category: "Time Words", front: "now", arabic: "ŸáŸÑŸëŸÇ", translit: "halla" },

      // 2. Time & Clock Language
      { category: "Time Units", front: "time", arabic: "ŸàŸÇÿ™", translit: "waet" },
      { category: "Time Units", front: "hour / o'clock", arabic: "ÿ≥ÿßÿπÿ©", translit: "saa-a" },
      { category: "Time Units", front: "hours", arabic: "ÿ≥ÿßÿπÿßÿ™", translit: "saa-aat" },
      { category: "Time Units", front: "minute", arabic: "ÿØŸÇŸäŸÇÿ©", translit: "da-ee-a" },
      { category: "Time Units", front: "minutes", arabic: "ÿØŸÇÿßŸäŸÇ", translit: "da-aa-yek" },
      { category: "Time Units", front: "second", arabic: "ÿ´ÿßŸÜŸäÿ©", translit: "saniyeh" },
      { category: "Time Units", front: "seconds", arabic: "ÿ´ŸàÿßŸÜŸä", translit: "tawani" },

      { category: "Fractions", front: "quarter", arabic: "ÿ±ÿ®ÿπ", translit: "rebaa" },
      { category: "Fractions", front: "third", arabic: "ÿ™ŸÑÿ™", translit: "telt" },
      { category: "Fractions", front: "half", arabic: "ŸÜÿµ", translit: "noss" },
      { category: "Fractions", front: "almost", arabic: "ÿ™ŸÇÿ±Ÿäÿ®Ÿãÿß", translit: "ta-reeban" },
      { category: "Fractions", front: "except / minus", arabic: "ÿ•ŸÑÿß", translit: "ella" },

      // 3. Seasons
      { category: "Seasons", front: "season", arabic: "ŸÅÿµŸÑ", translit: "fasel" },
      { category: "Seasons", front: "seasons", arabic: "ŸÅÿµŸàŸÑ", translit: "fusoool" },
      { category: "Seasons", front: "summer", arabic: "ÿµŸäŸÅ", translit: "seif" },
      { category: "Seasons", front: "winter", arabic: "ÿ¥ÿ™ÿß", translit: "sheta" },
      { category: "Seasons", front: "spring", arabic: "ÿ±ÿ®Ÿäÿπ", translit: "rabi" },
      { category: "Seasons", front: "fall / autumn", arabic: "ÿÆÿ±ŸäŸÅ", translit: "khareef" },

      { category: "Seasons Qs", front: "What's your favorite season? (to m)", arabic: "ÿ¥Ÿà ŸÅÿµŸÑŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑÿü", translit: "shu faslak el-mofaddal?" },
      { category: "Seasons Qs", front: "What's your favorite season? (to f)", arabic: "ÿ¥Ÿà ŸÅÿµŸÑŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑÿü", translit: "shu faslek el-mofaddal?" },
      { category: "Seasons Qs", front: "What is her favorite season?", arabic: "ÿ¥Ÿà ŸÅÿµŸÑŸáÿß ÿßŸÑŸÖŸÅÿ∂ŸÑÿü", translit: "shu fasel-ha el-mofaddal?" },
      { category: "Seasons Qs", front: "What is his favorite season?", arabic: "ÿ¥Ÿà ŸÅÿµŸÑŸá ÿßŸÑŸÖŸÅÿ∂ŸÑÿü", translit: "shu fasel-o el-mofaddal?" },
      { category: "Seasons Ans", front: "My favorite season is fall.", arabic: "ŸÅÿµŸÑŸä ÿßŸÑŸÖŸÅÿ∂ŸÑ ÿßŸÑÿÆÿ±ŸäŸÅ", translit: "fasle el-mofaddal el-khareef" },
      { category: "Seasons Ans", front: "Her favorite season is winter.", arabic: "ŸÅÿµŸÑŸáÿß ÿßŸÑŸÖŸÅÿ∂ŸÑ ÿßŸÑÿ¥ÿ™ÿß", translit: "fasel-ha el-mofaddal el-sheta" },

      // 4. Weather
      { category: "Weather", front: "weather", arabic: "ÿßŸÑÿ∑ŸÇÿ≥", translit: "el-ta-es" },
      { category: "Weather", front: "weather", arabic: "ÿßŸÑÿ¨Ÿà", translit: "el-jaw" },
      { category: "Weather", front: "nice / pleasant", arabic: "ÿ≠ŸÑŸà", translit: "helou" },
      { category: "Weather", front: "not nice", arabic: "ŸÖÿ¥ ÿ≠ŸÑŸà", translit: "mesh helou" },
      { category: "Weather", front: "very", arabic: "ŸÉÿ™Ÿäÿ±", translit: "kteer" },
      { category: "Weather", front: "hot (weather)", arabic: "ÿ¥Ÿàÿ®", translit: "shob" },
      { category: "Weather", front: "cold (weather)", arabic: "ÿ®ÿ±ÿØ", translit: "bard" },
      { category: "Weather", front: "warm", arabic: "ÿØÿßŸÅŸä", translit: "dafi" },
      { category: "Weather", front: "sunny", arabic: "ŸÖÿ¥ŸÖÿ≥", translit: "mshammes" },
      { category: "Weather", front: "cloudy", arabic: "ŸÖÿ∫ŸäŸÖ", translit: "mghayyem" },
      { category: "Weather", front: "rainy", arabic: "ŸÖŸÖÿ∑ÿ±", translit: "momter" },
      { category: "Weather", front: "snowy", arabic: "ŸÖÿ´ŸÑŸëÿ¨", translit: "mtallij" },

      { category: "Weather Nouns", front: "sun", arabic: "ÿ¥ŸÖÿ≥", translit: "shamas" },
      { category: "Weather Nouns", front: "rain", arabic: "ŸÖÿ∑ÿ±", translit: "matar" },
      { category: "Weather Nouns", front: "snow", arabic: "ÿ™ŸÑÿ¨", translit: "talj" },
      { category: "Weather Nouns", front: "wind / air", arabic: "ŸáŸàÿß", translit: "hawa" },

      { category: "Weather Phrases", front: "It's very windy.", arabic: "ŸÅŸä ŸÉÿ™Ÿäÿ± ŸáŸàÿß", translit: "fi kteer hawa" },
      { category: "Weather Phrases", front: "How is the weather today?", arabic: "ŸÉŸäŸÅ ÿßŸÑÿ¨Ÿà ÿßŸÑŸäŸàŸÖÿü", translit: "keef el-jaw elyom?" },
      { category: "Weather Phrases", front: "The weather today is nice.", arabic: "ÿßŸÑÿ¨Ÿà ÿßŸÑŸäŸàŸÖ ÿ≠ŸÑŸà", translit: "el-jaw elyom helou" },
      { category: "Weather Phrases", front: "The weather today is not nice.", arabic: "ÿßŸÑÿ¨Ÿà ÿßŸÑŸäŸàŸÖ ŸÖÿ¥ ÿ≠ŸÑŸà", translit: "el-jaw elyom mesh helou" },
      { category: "Weather Phrases", front: "The weather today is very nice.", arabic: "ÿßŸÑÿ¨Ÿà ÿßŸÑŸäŸàŸÖ ŸÉÿ™Ÿäÿ± ÿ≠ŸÑŸà", translit: "el-jaw elyom kteer helou" },
      { category: "Weather Phrases", front: "There is a lot of wind today.", arabic: "ŸÅŸä ŸÉÿ™Ÿäÿ± ŸáŸàÿß ÿßŸÑŸäŸàŸÖ", translit: "fi kteer hawa elyom" },
      { category: "Weather Phrases", front: "How is the weather in summer?", arabic: "ŸÉŸäŸÅ ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿµŸäŸÅÿü", translit: "keef el-jaw b-seif?" },
      { category: "Weather Phrases", front: "The weather in summer is very hot.", arabic: "ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿµŸäŸÅ ŸÉÿ™Ÿäÿ± ÿ¥Ÿàÿ®", translit: "el-jaw b-seif kteer shob" },
      { category: "Weather Phrases", front: "How is the weather in winter?", arabic: "ŸÉŸäŸÅ ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿ¥ÿ™ÿßÿü", translit: "keef el-jaw b-sheta?" },
      { category: "Weather Phrases", front: "The weather in winter is cold and snowy.", arabic: "ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿ¥ÿ™ÿß ÿ®ÿ±ÿØ ŸàŸÖÿ™ŸÑÿ¨", translit: "el-jaw b-sheta bard w mtallij" },
      { category: "Weather Phrases", front: "How is the weather in fall?", arabic: "ŸÉŸäŸÅ ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿÆÿ±ŸäŸÅÿü", translit: "keef el-jaw b-el-khareef?" },
      { category: "Weather Phrases", front: "How is the weather in spring?", arabic: "ŸÉŸäŸÅ ÿßŸÑÿ¨Ÿà ÿ®ÿßŸÑÿ±ÿ®Ÿäÿπÿü", translit: "keef el-jaw b-rabi?" },
      { category: "Weather Phrases", front: "The weather in spring is very warm.", arabic: "ÿßŸÑÿ∑ŸÇÿ≥ ÿ®ÿßŸÑÿ±ÿ®Ÿäÿπ ŸÉÿ™Ÿäÿ± ÿØÿßŸÅŸä", translit: "el-ta-es b-rabi kteer dafi" },
      { category: "Weather Phrases", front: "Tomorrow the weather is cold and rainy.", arabic: "ÿßŸÑÿ¨Ÿà ÿ®ŸÉÿ±ÿß ÿ®ÿ±ÿØ ŸàŸÖŸÖÿ∑ÿ±", translit: "el-jaw bukra bard w momter" },
      { category: "Weather Phrases", front: "Yesterday the weather was sunny.", arabic: "ÿßŸÑÿ¨Ÿà ŸÖÿ®ÿßÿ±ÿ≠ ŸÖÿ¥ŸÖÿ≥", translit: "el-jaw mbarah mshammes" },

      // 5. Have (ÿπŸÜÿØ)
      { category: "Have", front: "I have", arabic: "ÿπŸÜÿØŸä", translit: "andi" },
      { category: "Have", front: "you have (m)", arabic: "ÿπŸÜÿØŸÉ", translit: "andak" },
      { category: "Have", front: "you have (f)", arabic: "ÿπŸÜÿØŸêŸÉ", translit: "andek" },
      { category: "Have", front: "he has", arabic: "ÿπŸÜÿØŸá", translit: "ando" },
      { category: "Have", front: "she has", arabic: "ÿπŸÜÿØŸáÿß", translit: "anda" },
      { category: "Have", front: "we have", arabic: "ÿπŸÜÿØŸÜÿß", translit: "andna" },
      { category: "Have", front: "you (pl) have", arabic: "ÿπŸÜÿØŸÉŸÜ", translit: "andkon" },
      { category: "Have", front: "they have", arabic: "ÿπŸÜÿØŸÜ", translit: "andon" },

      { category: "Have Q&A", front: "Do you (m) have a question?", arabic: "ÿπŸÜÿØŸÉ ÿ≥ÿ§ÿßŸÑÿü", translit: "andak soal?" },
      { category: "Have Q&A", front: "Yes, I have a question.", arabic: "ÿ•Ÿäÿå ÿπŸÜÿØŸä ÿ≥ÿ§ÿßŸÑ", translit: "eh, andi soal" },
      { category: "Have Q&A", front: "No, I don't have a question.", arabic: "ŸÑÿßÿå ŸÖÿß ÿπŸÜÿØŸä ÿ≥ÿ§ÿßŸÑ", translit: "la, ma andi soal" },

      // 6. Question Words
      { category: "Questions", front: "what?", arabic: "ÿ¥Ÿà", translit: "shu" },
      { category: "Questions", front: "how?", arabic: "ŸÉŸäŸÅ", translit: "keef" },
      { category: "Questions", front: "where?", arabic: "ŸàŸäŸÜ", translit: "ween" },
      { category: "Questions", front: "when?", arabic: "ÿ•ŸÖÿ™Ÿâ", translit: "emta" },
      { category: "Questions", front: "why?", arabic: "ŸÑŸäÿ¥", translit: "lesh" },
      { category: "Questions", front: "who?", arabic: "ŸÖŸäŸÜ", translit: "meen" },
      { category: "Questions", front: "how much / how many?", arabic: "ŸÇÿØŸëŸäÿ¥", translit: "addeesh" },
      { category: "Questions", front: "is there / there is?", arabic: "ŸÅŸäÿü", translit: "fi?" },

      // 7. Pronouns
      { category: "Pronouns", front: "I", arabic: "ÿ£ŸÜÿß", translit: "ana" },
      { category: "Pronouns", front: "you (m)", arabic: "ÿ•ŸÜÿ™", translit: "enta" },
      { category: "Pronouns", front: "you (f)", arabic: "ÿ•ŸÜÿ™Ÿê", translit: "ente" },
      { category: "Pronouns", front: "he", arabic: "ŸáŸà", translit: "howwe" },
      { category: "Pronouns", front: "she", arabic: "ŸáŸä", translit: "heyye" },
      { category: "Pronouns", front: "we", arabic: "ŸÜÿ≠ŸÜÿß", translit: "nehna" },
      { category: "Pronouns", front: "you (pl)", arabic: "ÿ•ŸÜÿ™Ÿà", translit: "ento" },
      { category: "Pronouns", front: "they", arabic: "ŸáŸÜŸä", translit: "henne" },

      // 8. Everyday Phrases
      { category: "Everyday", front: "How are you today? (to m)", arabic: "ŸÉŸäŸÅŸÉ ÿßŸÑŸäŸàŸÖÿü", translit: "keefak elyom?" },
      { category: "Everyday", front: "How are you today? (to f)", arabic: "ŸÉŸäŸÅŸÉ ÿßŸÑŸäŸàŸÖÿü", translit: "keefek elyom?" },
      { category: "Everyday", front: "I'm good (m).", arabic: "ŸÖŸÜŸäÿ≠", translit: "mneeh" },
      { category: "Everyday", front: "I'm good (f).", arabic: "ŸÖŸÜŸäÿ≠ÿ©", translit: "mneeha" },
      { category: "Everyday", front: "My day is good.", arabic: "ŸäŸàŸÖŸä ŸÖŸÜŸäÿ≠", translit: "yomi mneeh" },
      { category: "Everyday", front: "Just a second.", arabic: "ŸÑÿ≠ÿ∏ÿ©", translit: "lahza" },
      { category: "Everyday", front: "only / just / but", arabic: "ÿ®ÿ≥", translit: "bas" },

      // 9. Feelings & adjectives
      { category: "Feelings", front: "hungry (m)", arabic: "ÿ¨ŸàÿπÿßŸÜ", translit: "jouaan" },
      { category: "Feelings", front: "hungry (f)", arabic: "ÿ¨ŸàÿπÿßŸÜÿ©", translit: "jouaaneh" },
      { category: "Feelings", front: "thirsty (m)", arabic: "ÿπÿ∑ÿ¥ÿßŸÜ", translit: "atshan" },
      { category: "Feelings", front: "thirsty (f)", arabic: "ÿπÿ∑ÿ¥ÿßŸÜÿ©", translit: "atshaneh" },
      { category: "Feelings", front: "tired (m)", arabic: "ÿ™ÿπÿ®ÿßŸÜ", translit: "taaban" },
      { category: "Feelings", front: "tired (f)", arabic: "ÿ™ÿπÿ®ÿßŸÜÿ©", translit: "taabaneh" },
      { category: "Feelings", front: "cold (feeling, m)", arabic: "ÿ®ÿ±ÿØÿßŸÜ", translit: "bardan" },
      { category: "Feelings", front: "cold (feeling, f)", arabic: "ÿ®ÿ±ÿØÿßŸÜÿ©", translit: "bardaneh" },
      { category: "Feelings", front: "hot (feeling, m)", arabic: "ŸÖÿ¥Ÿàÿ®", translit: "mashoob" },
      { category: "Feelings", front: "hot (feeling, f)", arabic: "ŸÖÿ¥Ÿàÿ®ÿ©", translit: "mashoobeh" },
      { category: "Feelings", front: "happy (m)", arabic: "ŸÖÿ®ÿ≥Ÿàÿ∑", translit: "mabsout" },
      { category: "Feelings", front: "happy (f)", arabic: "ŸÖÿ®ÿ≥Ÿàÿ∑ÿ©", translit: "mabsouta" },
      { category: "Feelings", front: "sad (m)", arabic: "ÿ≤ÿπŸÑÿßŸÜ", translit: "zaalan" },
      { category: "Feelings", front: "sad (f)", arabic: "ÿ≤ÿπŸÑÿßŸÜÿ©", translit: "zaalaneh" },
      { category: "Feelings", front: "sick (m)", arabic: "ŸÖÿ±Ÿäÿ∂", translit: "mareed" },
      { category: "Feelings", front: "sick (f)", arabic: "ŸÖÿ±Ÿäÿ∂ÿ©", translit: "mareeda" },
      { category: "Feelings", front: "I am hungry (m)", arabic: "ÿ£ŸÜÿß ÿ¨ŸàÿπÿßŸÜ", translit: "ana jouaan" },
      { category: "Feelings", front: "I am tired (f)", arabic: "ÿ£ŸÜÿß ÿ™ÿπÿ®ÿßŸÜÿ©", translit: "ana taabaneh" },

      // 10. Verbs: want / like / need
      { category: "Verbs", front: "I want", arabic: "ÿ®ÿØŸä", translit: "bedde" },
      { category: "Verbs", front: "you want (m)", arabic: "ÿ®ÿØŸÉ", translit: "bedak" },
      { category: "Verbs", front: "you want (f)", arabic: "ÿ®ÿØŸêŸÉ", translit: "bedek" },
      { category: "Verbs", front: "he wants", arabic: "ÿ®ÿØŸá", translit: "bedo" },
      { category: "Verbs", front: "she wants", arabic: "ÿ®ÿØŸáÿß", translit: "beda" },
      { category: "Verbs", front: "I like / I love", arabic: "ÿ®ÿ≠ÿ®", translit: "behebb" },
      { category: "Verbs", front: "I need", arabic: "ŸÑÿßÿ≤ŸÖ", translit: "lazem" },
      { category: "Verbs", front: "I want coffee.", arabic: "ÿ®ÿØŸä ŸÇŸáŸàÿ©", translit: "bedde ahwe" },
      { category: "Verbs", front: "I like Beirut.", arabic: "ÿ®ÿ≠ÿ® ÿ®Ÿäÿ±Ÿàÿ™", translit: "behebb Beirut" }
    ];

    // ---- STATE & STORAGE ----
    const STORAGE_KNOWN = "lev_flashcards_known_v1";
    const STORAGE_META = "lev_flashcards_meta_v1";
    const STORAGE_STREAK = "lev_flashcards_streak_v1";

    function cardId(card) {
      return `${card.category}|${card.front}|${card.arabic}`;
    }

    function loadKnownSet() {
      try {
        const raw = localStorage.getItem(STORAGE_KNOWN);
        if (!raw) return new Set();
        return new Set(JSON.parse(raw));
      } catch {
        return new Set();
      }
    }

    function saveKnownSet(set) {
      localStorage.setItem(STORAGE_KNOWN, JSON.stringify(Array.from(set)));
    }

    function loadMeta() {
      try {
        const raw = localStorage.getItem(STORAGE_META);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveMeta(meta) {
      localStorage.setItem(STORAGE_META, JSON.stringify(meta));
    }

    function loadStreak() {
      try {
        const raw = localStorage.getItem(STORAGE_STREAK);
        return raw ? JSON.parse(raw) : { streak: 0, lastDay: null };
      } catch {
        return { streak: 0, lastDay: null };
      }
    }

    function saveStreak(s) {
      localStorage.setItem(STORAGE_STREAK, JSON.stringify(s));
    }

    let knownSet = loadKnownSet();
    let meta = loadMeta();
    let streakData = loadStreak();

    let showFront = true;
    let currentIndex = 0;
    let filteredIndices = [];
    let smartMode = false;

    // quiz
    let quizDeck = [];
    let quizIndex = 0;
    let quizScore = 0;

    // ---- DOM ----
    const counterEl = document.getElementById("counter");
    const cardEl = document.getElementById("card");
    const cardContentEl = document.getElementById("card-content");
    const categoryPillEl = document.getElementById("category-pill");
    const sideLabelEl = document.getElementById("side-label");
    const knownPillEl = document.getElementById("known-pill");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const flipBtn = document.getElementById("flip-btn");
    const shuffleBtn = document.getElementById("shuffle-btn");
    const toggleKnownBtn = document.getElementById("toggle-known-btn");
    const categoryFilterEl = document.getElementById("category-filter");
    const statusFilterEl = document.getElementById("status-filter");
    const smartModeChip = document.getElementById("smart-mode-chip");
    const streakLabel = document.getElementById("streak-label");
    const typingToggleBtn = document.getElementById("typing-toggle-btn");
    const typingArea = document.getElementById("typing-area");
    const typingInput = document.getElementById("typing-input");
    const typingFeedback = document.getElementById("typing-feedback");
    const canvasToggleBtn = document.getElementById("canvas-toggle-btn");
    const canvasWrap = document.getElementById("canvas-wrap");
    const canvas = document.getElementById("write-canvas");
    const clearCanvasBtn = document.getElementById("clear-canvas-btn");
    const gotItBtn = document.getElementById("got-it-btn");
    const oopsBtn = document.getElementById("oops-btn");
    const audioBtn = document.getElementById("audio-btn");
    const hintText = document.getElementById("hint-text");

    const tabCards = document.getElementById("tab-cards");
    const tabQuiz = document.getElementById("tab-quiz");
    const cardsView = document.getElementById("cards-view");
    const quizView = document.getElementById("quiz-view");
    const quizPanel = document.getElementById("quiz-panel");
    const quizQuestion = document.getElementById("quiz-question");
    const quizOptions = document.getElementById("quiz-options");
    const quizProgress = document.getElementById("quiz-progress");
    const quizResult = document.getElementById("quiz-result");
    const startQuizBtn = document.getElementById("start-quiz-btn");
    const resetQuizBtn = document.getElementById("reset-quiz-btn");

    // ---- CATEGORY FILTER UI ----
    const categorySet = new Set(cards.map(c => c.category));
    const categories = ["All"].concat(Array.from(categorySet).sort());
    categories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoryFilterEl.appendChild(opt);
    });
    categoryFilterEl.value = "All";

    function recomputeFilteredIndices() {
      const catFilter = categoryFilterEl.value;
      const statusFilter = statusFilterEl.value;
      const now = Date.now();

      let indices = [];
      cards.forEach((card, idx) => {
        if (catFilter !== "All" && card.category !== catFilter) return;
        const id = cardId(card);
        const isKnown = knownSet.has(id);
        if (statusFilter === "known" && !isKnown) return;
        if (statusFilter === "unknown" && isKnown) return;
        indices.push(idx);
      });

      if (smartMode) {
        indices.sort((a, b) => {
          const ca = cards[a], cb = cards[b];
          const ma = meta[cardId(ca)] || {};
          const mb = meta[cardId(cb)] || {};
          const da = ma.nextDue || 0;
          const db = mb.nextDue || 0;
          return (da || 0) - (db || 0);
        });
      }

      filteredIndices = indices;

      if (filteredIndices.length === 0) {
        currentIndex = 0;
      } else if (!filteredIndices.includes(currentIndex)) {
        currentIndex = filteredIndices[0];
      }
    }

    function getFilteredPosition() {
      const pos = filteredIndices.indexOf(currentIndex);
      return pos === -1 ? 0 : pos;
    }

    function renderStreak() {
      const today = new Date();
      const dayStr = today.toISOString().slice(0, 10);
      if (streakData.lastDay !== dayStr) {
        const yesterday = new Date(today.getTime() - 86400000).toISOString().slice(0,10);
        if (streakData.lastDay === yesterday) {
          streakData.streak += 1;
        } else {
          streakData.streak = 1;
        }
        streakData.lastDay = dayStr;
        saveStreak(streakData);
      }
      streakLabel.textContent = `üî• ${streakData.streak}-day streak`;
    }

    function renderCard() {
      recomputeFilteredIndices();

      if (filteredIndices.length === 0) {
        cardContentEl.innerHTML = "<div style='font-size:0.9rem;color:#9ca3af;'>No cards match this filter.</div>";
        counterEl.textContent = "0 / 0";
        categoryPillEl.textContent = "None";
        sideLabelEl.textContent = showFront ? "Front ¬∑ EN" : "Back ¬∑ AR";
        knownPillEl.style.display = "none";
        toggleKnownBtn.textContent = "Mark as Known ‚úÖ";
        return;
      }

      const card = cards[currentIndex];
      const position = getFilteredPosition();
      counterEl.textContent = `${position + 1} / ${filteredIndices.length}`;
      categoryPillEl.textContent = card.category || "Card";

      const id = cardId(card);
      const isKnown = knownSet.has(id);
      knownPillEl.style.display = isKnown ? "block" : "none";
      toggleKnownBtn.textContent = isKnown ? "Mark as Unknown ‚óªÔ∏é" : "Mark as Known ‚úÖ";

      cardContentEl.innerHTML = "";
      if (showFront) {
        sideLabelEl.textContent = "Front ¬∑ EN";
        const en = document.createElement("div");
        en.className = "english";
        en.textContent = card.front;
        cardContentEl.appendChild(en);
        hintText.textContent = "Tap card / Flip to see Arabic ¬∑ ÿßÿ∂ÿ∫ÿ∑ / ÿ•ÿ∂ÿ∫ÿ∑Ÿä ŸÑÿ™ŸÇŸÑŸäÿ® ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©";
      } else {
        sideLabelEl.textContent = "Back ¬∑ AR";
        const ar = document.createElement("div");
        ar.className = "arabic";
        ar.textContent = card.arabic;
        const tr = document.createElement("div");
        tr.className = "translit";
        tr.textContent = card.translit;
        cardContentEl.appendChild(ar);
        cardContentEl.appendChild(tr);
        hintText.textContent = "Tap card / Flip to go back ¬∑ ÿ¨ÿ±Ÿëÿ® ÿ™ŸÜÿ∑ŸÇŸáÿß ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸä";
      }
    }

    function moveNext() {
      recomputeFilteredIndices();
      if (filteredIndices.length === 0) return;
      const pos = getFilteredPosition();
      const nextPos = (pos + 1) % filteredIndices.length;
      currentIndex = filteredIndices[nextPos];
      showFront = true;
      typingInput.value = "";
      typingFeedback.textContent = "";
      renderCard();
    }

    function movePrev() {
      recomputeFilteredIndices();
      if (filteredIndices.length === 0) return;
      const pos = getFilteredPosition();
      const prevPos = (pos - 1 + filteredIndices.length) % filteredIndices.length;
      currentIndex = filteredIndices[prevPos];
      showFront = true;
      typingInput.value = "";
      typingFeedback.textContent = "";
      renderCard();
    }

    function flipCard() {
      showFront = !showFront;
      renderCard();
    }

    function shuffleDeck() {
      for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
      }
      showFront = true;
      currentIndex = 0;
      renderCard();
    }

    function toggleKnown() {
      const card = cards[currentIndex];
      const id = cardId(card);
      if (knownSet.has(id)) {
        knownSet.delete(id);
      } else {
        knownSet.add(id);
      }
      saveKnownSet(knownSet);
      renderCard();
    }

    function normalize(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9ÿ°ÿßÿ£ÿ•ÿ¢ÿ§ÿ¶ÿ®ÿ©ÿ™ÿ´ÿ¨ÿ≠ÿÆÿØÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ÿπÿ∫ŸÅŸÇŸÉŸÑŸÖŸÜŸáŸàŸä]/g, "");
    }

    function checkTyping() {
      const card = cards[currentIndex];
      const expected = normalize(card.translit);
      const typed = normalize(typingInput.value);
      if (!typed) {
        typingFeedback.textContent = "";
        typingFeedback.className = "typing-feedback";
        return;
      }
      if (typed === expected) {
        typingFeedback.textContent = "‚úîÔ∏é Correct!";
        typingFeedback.className = "typing-feedback ok";
      } else {
        typingFeedback.textContent = `‚úó Not quite. Answer: ${card.translit}`;
        typingFeedback.className = "typing-feedback bad";
      }
    }

    function toggleTyping() {
      const active = typingArea.style.display === "block";
      typingArea.style.display = active ? "none" : "block";
      typingToggleBtn.classList.toggle("primary", !active);
      typingToggleBtn.classList.toggle("ghost", active);
      if (!active) typingInput.focus();
    }

    // handwriting canvas
    let drawing = false;
    let lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      const ctx = canvas.getContext("2d");
      ctx.scale(ratio, ratio);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#f97316";
      ctx.lineWidth = 4;
    }

    function startDraw(x, y) {
      drawing = true;
      lastX = x;
      lastY = y;
    }
    function drawTo(x, y) {
      if (!drawing) return;
      const ctx = canvas.getContext("2d");
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
    }
    function endDraw() {
      drawing = false;
    }

    function setupCanvasEvents() {
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);
      canvas.addEventListener("mousedown", e => startDraw(e.offsetX, e.offsetY));
      canvas.addEventListener("mousemove", e => drawTo(e.offsetX, e.offsetY));
      window.addEventListener("mouseup", endDraw);
      canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        startDraw(t.clientX - rect.left, t.clientY - rect.top);
      }, {passive:false});
      canvas.addEventListener("touchmove", e => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        drawTo(t.clientX - rect.left, t.clientY - rect.top);
      }, {passive:false});
      window.addEventListener("touchend", endDraw);
    }

    function toggleCanvas() {
      const active = canvasWrap.style.display === "flex";
      canvasWrap.style.display = active ? "none" : "flex";
      canvasToggleBtn.classList.toggle("primary", !active);
      canvasToggleBtn.classList.toggle("ghost", active);
      if (!active) resizeCanvas();
    }

    clearCanvasBtn.addEventListener("click", () => {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // spaced repetition-ish
    function updateMeta(correct) {
      const card = cards[currentIndex];
      const id = cardId(card);
      const now = Date.now();
      const info = meta[id] || { box: 1, lastSeen: now, nextDue: now };
      if (correct) {
        info.box = Math.min(info.box + 1, 5);
      } else {
        info.box = 1;
      }
      const intervals = [0, 1, 2, 4, 7, 14]; // days
      const days = intervals[info.box] || 14;
      info.lastSeen = now;
      info.nextDue = now + days * 86400000;
      meta[id] = info;
      saveMeta(meta);
    }

    function markGotIt() {
      updateMeta(true);
      moveNext();
    }

    function markOops() {
      updateMeta(false);
      moveNext();
    }

    function toggleSmartMode() {
      smartMode = !smartMode;
      smartModeChip.classList.toggle("active", smartMode);
      smartModeChip.textContent = smartMode ? "Smart mode: on" : "Smart mode: off";
      showFront = true;
      renderCard();
    }

    // audio
    function speakCurrent() {
      const card = cards[currentIndex];
      if (!window.speechSynthesis) {
        alert("Speech not supported on this device.");
        return;
      }
      const utter = new SpeechSynthesisUtterance(card.arabic);
      utter.lang = "ar-LB"; // Lebanese Arabic if available
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // quiz
    function buildQuizDeck() {
      const baseIndices = [...Array(cards.length).keys()];
      // simple shuffle
      for (let i = baseIndices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [baseIndices[i], baseIndices[j]] = [baseIndices[j], baseIndices[i]];
      }
      quizDeck = baseIndices.slice(0, 15); // up to 15 questions
      quizIndex = 0;
      quizScore = 0;
    }

    function renderQuizQuestion() {
      if (quizDeck.length === 0 || quizIndex >= quizDeck.length) {
        quizPanel.style.display = "flex";
        quizQuestion.textContent = "Quiz finished!";
        quizOptions.innerHTML = "";
        quizProgress.textContent = "";
        quizResult.textContent = `Score: ${quizScore}/${quizDeck.length}`;
        return;
      }
      quizPanel.style.display = "flex";
      const idx = quizDeck[quizIndex];
      const card = cards[idx];
      quizQuestion.textContent = `What is the Arabic for: ‚Äú${card.front}‚Äù?`;
      const correct = card.arabic;
      // pick 3 other random cards
      const others = [];
      while (others.length < 3) {
        const r = Math.floor(Math.random() * cards.length);
        if (r !== idx && !others.includes(r)) others.push(r);
      }
      const options = [correct, ...others.map(i => cards[i].arabic)];
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }

      quizOptions.innerHTML = "";
      options.forEach(opt => {
        const div = document.createElement("div");
        div.className = "quiz-option";
        div.textContent = opt;
        div.addEventListener("click", () => {
          if (div.dataset.clicked) return;
          div.dataset.clicked = "1";
          if (opt === correct) {
            div.classList.add("correct");
            quizScore++;
            quizResult.textContent = "Correct ‚úÖ";
          } else {
            div.classList.add("wrong");
            quizResult.textContent = `Answer: ${correct}`;
          }
          setTimeout(() => {
            quizIndex++;
            quizResult.textContent = "";
            renderQuizQuestion();
          }, 800);
        });
        quizOptions.appendChild(div);
      });

      quizProgress.textContent = `${quizIndex + 1} / ${quizDeck.length}`;
    }

    function startQuiz() {
      buildQuizDeck();
      renderQuizQuestion();
    }

    function resetQuiz() {
      quizDeck = [];
      quizIndex = 0;
      quizScore = 0;
      quizPanel.style.display = "none";
      quizQuestion.textContent = "";
      quizOptions.innerHTML = "";
      quizProgress.textContent = "";
      quizResult.textContent = "";
    }

    // tabs
    function showCardsTab() {
      tabCards.classList.add("active");
      tabQuiz.classList.remove("active");
      cardsView.style.display = "block";
      quizView.style.display = "none";
    }
    function showQuizTab() {
      tabQuiz.classList.add("active");
      tabCards.classList.remove("active");
      cardsView.style.display = "none";
      quizView.style.display = "block";
    }

    // ---- EVENT BINDINGS ----
    cardEl.addEventListener("click", flipCard);
    flipBtn.addEventListener("click", flipCard);
    nextBtn.addEventListener("click", moveNext);
    prevBtn.addEventListener("click", movePrev);
    shuffleBtn.addEventListener("click", shuffleDeck);
    toggleKnownBtn.addEventListener("click", toggleKnown);
    categoryFilterEl.addEventListener("change", () => {
      showFront = true;
      renderCard();
    });
    statusFilterEl.addEventListener("change", () => {
      showFront = true;
      renderCard();
    });
    smartModeChip.addEventListener("click", toggleSmartMode);
    typingToggleBtn.addEventListener("click", toggleTyping);
    typingInput.addEventListener("input", checkTyping);
    canvasToggleBtn.addEventListener("click", toggleCanvas);
    gotItBtn.addEventListener("click", markGotIt);
    oopsBtn.addEventListener("click", markOops);
    audioBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      speakCurrent();
    });

    tabCards.addEventListener("click", showCardsTab);
    tabQuiz.addEventListener("click", showQuizTab);
    startQuizBtn.addEventListener("click", startQuiz);
    resetQuizBtn.addEventListener("click", resetQuiz);

    // init
    setupCanvasEvents();
    renderStreak();
    renderCard();
  </script>
</body>
</html>
